services:
    main:
        image: rslethz/grandtour-datasets:api-server-latest
        container_name: API
        build:
            context: .
            dockerfile: backend/Dockerfile
        volumes:
            - ./backend:/usr/src/app/backend
            - ./common:/usr/src/app/common
            - /usr/src/app/node_modules
            - swagger-spec:/usr/src/app/backend/docs

        ports:
            - 127.0.0.1:${SERVER_PORT}:${SERVER_PORT}
        env_file:
            - .env
        networks:
            - webnet
            - privatenet

        environment:
            DEVBUILD: 'true'

        depends_on:
            - database

    database:
        image: postgres:13
        container_name: postgres_db
        ports:
            - '5432:5432'
        networks:
            - privatenet
        environment:
            POSTGRES_DB: ${DB_DATABASE}
            POSTGRES_USER: ${DB_USER}
            POSTGRES_PASSWORD: ${DB_PASSWORD}
        volumes:
            - db_data:/var/lib/postgresql/data

    minio:
        image: minio/minio
        volumes:
            - minio_data:/data
        environment:
            MINIO_ROOT_USER: ${MINIO_USER}
            MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
        entrypoint: sh
        # initialize buckets (see https://github.com/minio/minio/issues/4769#issuecomment-331033735)
        # and add service worker access key after startup of the minio server
        command: >
            -c "mkdir -p /data/${MINIO_BAG_BUCKET_NAME} &&
            mkdir -p /data/${MINIO_MCAP_BUCKET_NAME} && 
            mkdir -p /data/${MINIO_DB_BUCKET_NAME} &&
            /usr/bin/minio server --console-address ':9001' /data & 
            sleep 10 &&
            mc alias set myminio http://minio:9000 ${MINIO_USER} ${MINIO_PASSWORD} &&
            mc admin user svcacct add --access-key '${MINIO_ACCESS_KEY}' --secret-key '${MINIO_SECRET_KEY}' myminio ${MINIO_USER} || true &&
            echo 'minio is ready' &&
            sleep infinity"
        ports:
            - '127.0.0.1:9000:9000'
            - '127.0.0.1:9001:9001'
        networks:
            - webnet
            - privatenet

    frontend:
        image: rslethz/grandtour-datasets:vuejs_frontend-latest
        build:
            context: .
            dockerfile: ./frontend/dev.Dockerfile
            args:
                - QUASAR_ENDPOINT=${QUASAR_ENDPOINT}
        container_name: vuejs_frontend
        ports:
            - '8003:8003'

        env_file:
            - .env

        develop:
            watch:
                - action: sync
                  path: ./frontend
                  target: /app

        networks:
            - webnet

    redis:
        image: redis:latest
        ports:
            - '6379:6379'
        networks:
            - privatenet

    bullconsumer:
        image: rslethz/grandtour-datasets:bull-consumer-latest
        container_name: bullconsumer
        build:
            context: .
            dockerfile: queueConsumer/Dockerfile
        volumes:
            - ./queueConsumer:/usr/src/queueConsumer
            - ./common:/usr/src/common
            - /usr/src/queueConsumer/node_modules
            - /usr/src/queueConsumer/dist
            # mount docker socket to access docker from within the container
            - /var/run/docker.sock:/var/run/docker.sock
        develop:
            watch:
                - action: sync
                  path: ./queueConsumer
                  target: /usr/src/queueConsumer
                  ignore:
                      - node_modules/
                      - dist/
        env_file:
            - .env
        networks:
            - privatenet
        depends_on:
            - database
            - loki

    prometheus:
        image: prom/prometheus
        volumes:
            - ./observability/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
            - logging-prometheus-storage:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
        ports:
            - '9090:9090'
        networks:
            - privatenet
            - webnet

    tempo:
        user: '0:0'
        image: grafana/tempo:latest
        command: ['-config.file=/etc/tempo/tempo.yml']
        volumes:
            - ./observability/tempo/tempo.yml:/etc/tempo/tempo.yml
            - logging-tempo-data:/tmp/tempo
        ports:
            - '3200' # tempo
            - '4317' # otlp grpc
            - '4318' # otlp http
        networks:
            - privatenet
            - webnet

    loki:
        image: grafana/loki
        container_name: loki
        ports:
            - '3100:3100'
        command:
            - --config.file=/mnt/config/loki-config.yml
        volumes:
            - ./observability/loki/loki-config.yml:/mnt/config/loki-config.yml:ro
        networks:
            - privatenet
            - webnet

    grafana:
        image: grafana/grafana
        volumes:
            - logging-grafana-storage:/var/lib/grafana
            - ./observability/grafana/provisioning:/etc/grafana/provisioning

        environment:
            - GF_LOG_LEVEL=critical
        ports:
            - '9050:3000' # localhost:9050 for accessing grafana
        networks:
            - privatenet
            - webnet

    docs:
        depends_on:
            - main
        image: rslethz/grandtour-datasets:docs-latest
        build:
            context: docs/.
            dockerfile: local-dev.Dockerfile
        ports:
            - '4000:4000'
        volumes:
            - ./docs:/app/src
            - vitepress_dist:/app/src/.vitepress/dist
            - node_modules:/app/src/node_modules
            - swagger-spec:/app/src/docs/

volumes:
    db_data:
    minio_data:
    logging-prometheus-storage:
    logging-grafana-storage:
    logging-tempo-data:
    vitepress_dist:
    node_modules:
    swagger-spec:

networks:
    webnet:
    privatenet:
